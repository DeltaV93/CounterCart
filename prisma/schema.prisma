generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // directUrl is optional - only needed for Supabase connection pooler
  // For Railway PostgreSQL, just use DATABASE_URL
}

model User {
  id                  String    @id @default(cuid())
  email               String    @unique
  name                String?
  stripeCustomerId    String?   @unique
  subscriptionTier    String    @default("free") // "free" | "premium"
  subscriptionStatus  String?   // "active" | "canceled" | "past_due"
  donationMultiplier  Decimal   @default(1.0) @db.Decimal(3, 2)
  monthlyLimit        Decimal?  @db.Decimal(10, 2)
  currentMonthTotal   Decimal   @default(0) @db.Decimal(10, 2)
  autoDonateEnabled   Boolean   @default(false)
  onboardingComplete  Boolean   @default(false)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Notification preferences
  notifyDonationComplete   Boolean @default(true)
  notifyWeeklySummary      Boolean @default(true)
  notifyNewMatch           Boolean @default(false)
  notifyPaymentFailed      Boolean @default(true)
  notifyBankDisconnected   Boolean @default(true)

  // Change API integration
  changeCustomerId    String?   @unique  // Change API customer ID

  // Referral system
  referralCode        String?   @unique  // e.g., "abc123" (6 chars)
  referredBy          String?             // Code of referrer
  referralCount       Int       @default(0)  // Track successful referrals

  // Badge/Profile
  badgeEnabled        Boolean   @default(false)
  badgeStyle          String    @default("minimal") // "minimal" | "detailed" | "compact"
  publicProfile       Boolean   @default(false)
  badges              String[]  @default([])

  plaidItems      PlaidItem[]
  userCauses      UserCause[]
  userCharities   UserCharity[]
  transactions    Transaction[]
  donations       Donation[]
  donationBatches DonationBatch[]

  // Growth features relations
  clubMemberships            ClubMember[]
  challengeParticipations    ChallengeParticipant[]
  orgMemberships             OrgMember[]
  giftsPurchased             GiftSubscription[] @relation("GiftsPurchased")
  giftsRedeemed              GiftSubscription[] @relation("GiftsRedeemed")

  @@index([email])
  @@index([stripeCustomerId])
  @@index([referralCode])
}

model PlaidItem {
  id              String          @id @default(cuid())
  userId          String
  accessToken     String          // Encrypted with AES-256-GCM
  itemId          String          @unique
  institutionId   String
  institutionName String
  cursor          String?         // For transaction sync pagination
  status          PlaidItemStatus @default(ACTIVE)
  errorCode       String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  bankAccounts BankAccount[]

  @@index([userId])
  @@index([itemId])
}

enum PlaidItemStatus {
  ACTIVE
  LOGIN_REQUIRED
  ERROR
  DISCONNECTED
}

model BankAccount {
  id             String   @id @default(cuid())
  plaidItemId    String
  plaidAccountId String   @unique
  name           String
  officialName   String?
  type           String   // checking, savings, credit
  subtype        String?
  mask           String?  // Last 4 digits
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())

  // ACH payment fields (for auto-donations via Stripe)
  stripePaymentMethodId String?   // Stripe PaymentMethod ID for ACH debit
  achEnabled            Boolean   @default(false)
  achAuthorizedAt       DateTime? // When user signed ACH mandate

  plaidItem    PlaidItem     @relation(fields: [plaidItemId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([plaidItemId])
  @@index([plaidAccountId])
}

model Cause {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  iconName    String?  // Lucide icon name
  color       String?  // Tailwind color class
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  userCauses       UserCause[]
  businessMappings BusinessMapping[]
  charities        Charity[]
  clubs            Club[]
  challenges       Challenge[]
  donations        Donation[]  // Donations designated for this cause

  @@index([slug])
}

model UserCause {
  id        String   @id @default(cuid())
  userId    String
  causeId   String
  priority  Int      @default(1)
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  cause Cause @relation(fields: [causeId], references: [id], onDelete: Cascade)

  @@unique([userId, causeId])
  @@index([userId])
}

model UserCharity {
  id        String   @id @default(cuid())
  userId    String
  causeId   String
  charityId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  charity Charity @relation(fields: [charityId], references: [id], onDelete: Cascade)

  @@unique([userId, causeId])
  @@index([userId])
  @@index([charityId])
}

model BusinessMapping {
  id              String   @id @default(cuid())
  merchantPattern String   // Pattern to match against merchant names (case-insensitive)
  merchantName    String   // Human-readable display name
  causeId         String
  charitySlug     String   // Every.org charity slug
  charityName     String
  reason          String?  // Why this business is mapped to this cause
  confidence      Decimal  @default(1.0) @db.Decimal(3, 2)
  source          String   @default("manual") // "manual" | "community" | "verified"
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  cause        Cause         @relation(fields: [causeId], references: [id])
  transactions Transaction[]

  @@index([merchantPattern])
  @@index([causeId])
  @@index([isActive])
}

model Charity {
  id           String   @id @default(cuid())
  causeId      String
  everyOrgSlug String   @unique
  name         String
  description  String?
  ein          String?  // Tax ID
  logoUrl      String?
  websiteUrl   String?
  isDefault    Boolean  @default(false)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())

  // Change API integration
  changeNonprofitId String?  // Change API nonprofit ID for auto-donations

  cause         Cause         @relation(fields: [causeId], references: [id])
  donations     Donation[]
  userCharities UserCharity[]

  @@index([causeId])
  @@index([everyOrgSlug])
  @@index([causeId, isDefault])
}

model Transaction {
  id                 String            @id @default(cuid())
  userId             String
  bankAccountId      String
  plaidTransactionId String            @unique
  merchantName       String
  merchantNameNorm   String            // Normalized for matching
  amount             Decimal           @db.Decimal(10, 2)
  date               DateTime          @db.Date
  category           String[]
  matchedMappingId   String?
  status             TransactionStatus @default(PENDING)
  createdAt          DateTime          @default(now())

  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  bankAccount    BankAccount      @relation(fields: [bankAccountId], references: [id])
  matchedMapping BusinessMapping? @relation(fields: [matchedMappingId], references: [id])
  donation       Donation?

  @@index([userId, date])
  @@index([plaidTransactionId])
  @@index([merchantNameNorm])
  @@index([status])
  @@index([userId, status, date])
}

enum TransactionStatus {
  PENDING
  MATCHED
  BATCHED
  DONATED
  SKIPPED
  FAILED
}

model DonationBatch {
  id          String            @id @default(cuid())
  userId      String
  weekOf      DateTime          @db.Date // Sunday of the week
  totalAmount Decimal           @db.Decimal(10, 2)
  status      DonationBatchStatus @default(PENDING)
  processedAt DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Stripe ACH payment tracking
  stripePaymentIntentId String?   // Stripe PaymentIntent for ACH debit
  stripePaymentStatus   String?   // "requires_confirmation" | "processing" | "succeeded" | "failed"
  achDebitedAt          DateTime? // When ACH was successfully debited

  // Grant distribution tracking (Every.org Partner API)
  grantStatus              String?   // "pending" | "processing" | "completed" | "failed"
  everyOrgDisbursementId   String?   // Every.org disbursement batch reference
  grantedAt                DateTime? // When grants were disbursed to charities
  grantError               String?   // Error message if grant distribution failed

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  donations Donation[]

  @@unique([userId, weekOf])
  @@index([userId, status])
  @@index([weekOf])
  @@index([stripePaymentIntentId])
  @@index([everyOrgDisbursementId])
}

enum DonationBatchStatus {
  PENDING
  READY
  PROCESSING
  COMPLETED
  FAILED
}

model Donation {
  id             String         @id @default(cuid())
  userId         String
  batchId        String?
  transactionId  String?        @unique

  // Fiscal sponsor model: donations go to Tech by Choice
  // charityId/charitySlug/charityName are kept for backward compatibility
  // New donations use designatedCauseId to track where funds should go
  charityId      String?        // Optional - for backward compatibility
  charitySlug    String?        // Optional - for backward compatibility
  charityName    String?        // Optional - for backward compatibility

  // Fiscal sponsor tracking (new model)
  designatedCauseId  String?    // The cause this donation is designated for
  fiscalSponsorName  String     @default("Tech by Choice")  // Recipient org

  amount         Decimal        @db.Decimal(10, 2)
  status         DonationStatus @default(PENDING)
  everyOrgId     String?        @unique  // Every.org donation ID (for manual donations)
  changeId       String?        @unique  // Change API donation ID (for auto-donations)
  receiptUrl     String?
  errorMessage   String?
  createdAt      DateTime       @default(now())
  completedAt    DateTime?

  // Grant tracking (Every.org Partner API disbursement)
  grantStatus      String?   // "pending" | "granted" | "failed"
  everyOrgGrantId  String?   // Every.org grant reference for this donation
  grantedAt        DateTime? // When this donation was granted to charity

  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  batch            DonationBatch? @relation(fields: [batchId], references: [id])
  transaction      Transaction?   @relation(fields: [transactionId], references: [id])
  charity          Charity?       @relation(fields: [charityId], references: [id])
  designatedCause  Cause?         @relation(fields: [designatedCauseId], references: [id])

  @@index([userId, createdAt])
  @@index([status])
  @@index([batchId])
  @@index([everyOrgId])
  @@index([changeId])
  @@index([designatedCauseId])
  @@index([everyOrgGrantId])
}

enum DonationStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

model WebhookEvent {
  id          String        @id @default(cuid())
  source      String        // "plaid" | "stripe" | "every_org"
  eventType   String
  eventId     String?       // External event ID for idempotency
  payload     Json
  signature   String?
  processedAt DateTime?
  status      WebhookStatus @default(PENDING)
  error       String?
  retryCount  Int           @default(0)
  createdAt   DateTime      @default(now())

  @@unique([source, eventId])
  @@index([source, eventType])
  @@index([status])
  @@index([createdAt])
}

enum WebhookStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================
// GROWTH FEATURES MODELS
// ============================================

// Cause Clubs - Community groups around causes
model Club {
  id           String       @id @default(cuid())
  causeId      String
  name         String
  slug         String       @unique
  description  String?      @db.Text
  iconUrl      String?
  memberCount  Int          @default(0)
  totalDonated Decimal      @default(0) @db.Decimal(10, 2)
  rank         Int?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  cause        Cause        @relation(fields: [causeId], references: [id])
  members      ClubMember[]

  @@index([causeId])
  @@index([slug])
}

model ClubMember {
  id           String       @id @default(cuid())
  clubId       String
  userId       String
  role         String       @default("member") // "member" | "ambassador" | "founder"
  inviteCode   String       @unique  // Personal invite code
  contributed  Decimal      @default(0) @db.Decimal(10, 2)
  inviteCount  Int          @default(0)
  joinedAt     DateTime     @default(now())
  invitedById  String?

  club         Club         @relation(fields: [clubId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  invitedBy    ClubMember?  @relation("ClubInvites", fields: [invitedById], references: [id])
  invites      ClubMember[] @relation("ClubInvites")

  @@unique([clubId, userId])
  @@index([inviteCode])
}

// Offset Challenges - Time-limited community goals
model Challenge {
  id               String                  @id @default(cuid())
  slug             String                  @unique
  title            String
  description      String                  @db.Text
  shortDesc        String
  causeId          String?
  goalAmount       Decimal                 @db.Decimal(10, 2)
  currentAmount    Decimal                 @default(0) @db.Decimal(10, 2)
  participantCount Int                     @default(0)
  startDate        DateTime
  endDate          DateTime
  status           String                  @default("upcoming") // "upcoming" | "active" | "completed"
  imageUrl         String?
  badgeId          String?
  featured         Boolean                 @default(false)
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt

  cause            Cause?                  @relation(fields: [causeId], references: [id])
  participants     ChallengeParticipant[]

  @@index([status])
  @@index([startDate])
  @@index([endDate])
}

model ChallengeParticipant {
  id           String    @id @default(cuid())
  challengeId  String
  userId       String
  contributed  Decimal   @default(0) @db.Decimal(10, 2)
  joinedAt     DateTime  @default(now())
  earnedBadge  Boolean   @default(false)

  challenge    Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([challengeId, userId])
}

// B2B / Corporate Organizations
model Organization {
  id               String      @id @default(cuid())
  name             String
  slug             String      @unique
  domain           String?     // For domain-based auto-join
  inviteCode       String      @unique
  stripeCustomerId String?     @unique
  stripeSubId      String?
  plan             String      @default("team") // "team" | "enterprise"
  seatCount        Int         @default(0)
  maxSeats         Int         @default(50)
  totalDonated     Decimal     @default(0) @db.Decimal(10, 2)
  adminEmail       String
  logoUrl          String?
  settings         Json?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  members          OrgMember[]

  @@index([inviteCode])
  @@index([domain])
}

model OrgMember {
  id        String       @id @default(cuid())
  orgId     String
  userId    String
  role      String       @default("member") // "member" | "admin" | "owner"
  joinedAt  DateTime     @default(now())

  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([orgId, userId])
}

// Gift Subscriptions
model GiftSubscription {
  id              String    @id @default(cuid())
  code            String    @unique  // Redemption code
  purchaserId     String
  recipientEmail  String
  personalMessage String?   @db.Text
  amount          Decimal   @db.Decimal(10, 2)
  months          Int       @default(12)
  stripePaymentId String?
  status          String    @default("pending") // "pending" | "sent" | "redeemed" | "expired"
  sentAt          DateTime?
  redeemedBy      String?
  redeemedAt      DateTime?
  expiresAt       DateTime
  createdAt       DateTime  @default(now())

  purchaser       User      @relation("GiftsPurchased", fields: [purchaserId], references: [id])
  redeemer        User?     @relation("GiftsRedeemed", fields: [redeemedBy], references: [id])

  @@index([code])
  @@index([recipientEmail])
  @@index([purchaserId])
}
